From: Julien Cristau <jcristau@debian.org>
Date: Thu, 6 Sep 2007 22:20:24 +0200
Subject: [PATCH] config/dbus: don't call RemoveGeneralSocket if bus_info.fd == -1

Fixes a crash reported at:
http://bugs.freedesktop.org/show_bug.cgi?id=12291
http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=440547
---
 config/dbus-core.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/config/dbus-core.c b/config/dbus-core.c
index 2888159..d220cea 100644
--- a/config/dbus-core.c
+++ b/config/dbus-core.c
@@ -87,8 +87,10 @@ teardown(void)
         dbus_connection_unref(bus_info.connection);
 
     RemoveBlockAndWakeupHandlers(block_handler, wakeup_handler, &bus_info);
-    RemoveGeneralSocket(bus_info.fd);
-    bus_info.fd = -1;
+    if (bus_info.fd >= 0) {
+        RemoveGeneralSocket(bus_info.fd);
+        bus_info.fd = -1;
+    }
     bus_info.connection = NULL;
 
     for (hook = bus_info.hooks; hook; hook = hook->next) {
-- 
1.5.3.1

